<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css\index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <title>Document</title>
</head>

<body>
    <header>
        <div class="funcionario">
            <img src="img\usuario-do-circulo.png" alt="foto de perfil">
            <h3></h3>
        </div>

        <div class="deslogar">
            <h3 >Sair</h3>
            <img src="img\sair.png" alt="sair">
        </div>
    </header>

    <main>
        <div class="geral">
            <div class="container_op">

                <div class="opcao">
                    <div id="dados">
                        <h3>Setor</h3>
                        <h3>Nome do Usu√°rio</h3>
                    </div>
                    <div class="info-container">
                        <div class="info-item">
                            <img src="img/historico.png" alt="Hist√≥rico">
                            <h3>Hist√≥rico</h3>
                        </div>
                        <div class="info-item">
                            <img src="img/detalhamento.png" alt="Detalhamento de M√°quina">
                            <h3>Detalhamento de M√°quina</h3>
                        </div>
                        <div class="info-item">
                            <img src="img/agenda.png" alt="Agendar Manuten√ß√£o">
                            <h3>Agendar Manuten√ß√£o</h3>
                        </div>
                        <div class="info-item">
                            <img src="img/documentacao.png" alt="Registro de Manuten√ß√£o">
                            <h3>Registro de Manuten√ß√£o</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="cont_perfil_maquina">
                <div class="perfil">
                    <div class="perfil-info">
                        <p><strong>Nome</strong> | Cargo</p>
                        <p>N√≠vel de acesso | adm</p>
                    </div>
                    <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Usu√°rio">
                </div>
                <div class="maquinas">
                    <div class="lista-maquinas" id="listaMaquinas"></div>
                    <!-- Bot√£o "Adicionar M√°quina" separado da lista -->
                    <div class="add-maquina">
                        <a href="pagina_cadastro_maquina.html">
                            <img id="add_m" src="img/mais.png" alt="Adicionar M√°quina">
                        </a>
                    </div>
                </div>
            </div>

        </div>



    </main>
</body>

</html>


<script>
    // Verificar se o usu√°rio est√° logado
    const token = localStorage.getItem("token");

    if (!token) {
        window.location.href = "pagina_login.html"; // Redireciona para o login se n√£o estiver logado
    } else {
        // Exibir o nome do usu√°rio
        const user = JSON.parse(localStorage.getItem("user"));
        if (user && user.name) {
            document.querySelector(".funcionario h3").textContent = user.name;
        }
    }

    // Fun√ß√£o para deslogar
    function deslogar() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "pagina_login.html";
    }

    // Adicionar evento de clique ao bot√£o de deslogar
    document.querySelector(".deslogar").addEventListener("click", deslogar);

    // Fun√ß√£o para carregar as m√°quinas
    async function carregarMaquinas() {
        const listaMaquinas = document.getElementById("listaMaquinas");
        listaMaquinas.innerHTML = ""; // Limpa antes de carregar

        try {
            const response = await fetch("http://localhost:3000/items", {
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem("token")}`,
                },
            });

            if (!response.ok) {
                throw new Error("Erro ao carregar m√°quinas.");
            }

            const maquinas = await response.json();

            maquinas.forEach((maquina, index) => {
                const maquinaItem = document.createElement("div");
                maquinaItem.classList.add("maquina-item");
                maquinaItem.innerHTML = `
                    <p><strong>${maquina.nome} | ${maquina.codigo}</strong></p>
                    <p><strong>Setor</strong> | ${maquina.setor}</p>
                    <p><strong>Estado</strong> <span id="estado-${maquina.codigo}">${maquina.estado}</span></p>
                    <button class="remover-btn" onclick="removerMaquina(${maquina.id})">üóëÔ∏è Remover</button>
                `;
                listaMaquinas.appendChild(maquinaItem);
            });
        } catch (error) {
            console.error("Erro ao carregar m√°quinas:", error);
            alert("Erro ao carregar m√°quinas. Tente novamente.");
        }
    }

    // Fun√ß√£o para remover uma m√°quina
    async function removerMaquina(id) {
        try {
            const response = await fetch(`http://localhost:3000/items/${id}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem("token")}`,
                },
            });

            if (!response.ok) {
                throw new Error("Erro ao remover m√°quina.");
            }

            // Recarregar a lista de m√°quinas
            carregarMaquinas();
        } catch (error) {
            console.error("Erro ao remover m√°quina:", error);
            alert("Erro ao remover m√°quina. Tente novamente.");
        }
    }

    // Fun√ß√£o para ler o arquivo TXT e atualizar o estado das m√°quinas
    async function lerMudancasEstado() {
        try {
            const response = await fetch("http://localhost:3000/mudancas-estado");
            if (!response.ok) {
                throw new Error("Erro ao ler mudan√ßas de estado.");
            }

            const texto = await response.text();
            const linhas = texto.split("\n").filter((linha) => linha.trim() !== "");

            // Pega a √∫ltima linha (√∫ltima mudan√ßa de estado)
            const ultimaLinha = linhas[linhas.length - 1];
            if (ultimaLinha) {
                const estado = ultimaLinha.replace("Estado Previsto: ", "").trim();

                // Atualiza o estado na interface (substitua "codigo_da_maquina" pelo c√≥digo real)
                const estadoElement = document.getElementById("estado-codigo_da_maquina");
                if (estadoElement) {
                    estadoElement.textContent = estado;
                }
            }
        } catch (error) {
            console.error("Erro ao ler mudan√ßas de estado:", error);
        }
    }

    // Ler o arquivo TXT periodicamente (a cada 5 segundos)
    setInterval(lerMudancasEstado, 5000);

    // Carregar as m√°quinas ao abrir a p√°gina
    document.addEventListener("DOMContentLoaded", carregarMaquinas);
</script>
</body>

</html>